# School ERP Multi-Tenant Virtual Host Configuration
# Replace {{PROJECT_PATH}} with your actual project path when deploying

# Landing Page Server Block (myschool.com)
server {
    listen 80;
    listen [::]:80;
    server_name myschool.com www.myschool.com;
    
    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name myschool.com www.myschool.com;
    
    root {{PROJECT_PATH}}/public;
    index index.php index.html;
    
    # SSL Configuration (Update paths as needed)
    ssl_certificate /etc/ssl/certs/myschool.com.crt;
    ssl_certificate_key /etc/ssl/private/myschool.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    
    # Landing page routes (marketing site)
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    # PHP-FPM Configuration
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param HTTP_HOST $host;
        fastcgi_param APP_ENV "production";
        fastcgi_param APP_TYPE "landing";
        include fastcgi_params;
    }
    
    # Static assets
    location ~* \.(css|js|ico|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Deny access to sensitive files
    location ~ /\. {
        deny all;
    }
    
    location ~ /\.env {
        deny all;
    }
}

# Super Admin Server Block (app.myschool.com)
server {
    listen 80;
    listen [::]:80;
    server_name app.myschool.com;
    
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name app.myschool.com;
    
    root {{PROJECT_PATH}}/public;
    index index.php;
    
    # SSL Configuration
    ssl_certificate /etc/ssl/certs/myschool.com.crt;
    ssl_certificate_key /etc/ssl/private/myschool.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    
    # Admin routes
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    # PHP-FPM Configuration
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param HTTP_HOST $host;
        fastcgi_param APP_ENV "production";
        fastcgi_param APP_TYPE "admin";
        include fastcgi_params;
    }
    
    # Static assets
    location ~* \.(css|js|ico|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Deny access to sensitive files
    location ~ /\. {
        deny all;
    }
}

# Multi-Tenant Server Block (*.myschool.com + Custom Domains)
server {
    listen 80;
    listen [::]:80;
    server_name *.myschool.com;
    
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name *.myschool.com;
    
    root {{PROJECT_PATH}}/public;
    index index.php;
    
    # SSL Configuration (Wildcard cert)
    ssl_certificate /etc/ssl/certs/wildcard.myschool.com.crt;
    ssl_certificate_key /etc/ssl/private/wildcard.myschool.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    
    # Extract subdomain for tenant identification
    set $tenant_host $host;
    
    # Tenant application routes
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    # PHP-FPM Configuration with tenant context
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param HTTP_HOST $tenant_host;
        fastcgi_param APP_ENV "production";
        fastcgi_param APP_TYPE "tenant";
        include fastcgi_params;
        
        # Pass tenant identification to PHP
        fastcgi_param TENANT_HOST $tenant_host;
    }
    
    # Static assets with longer cache for tenant apps
    location ~* \.(css|js|ico|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Laravel storage files (if using public disk)
    location /storage {
        alias {{PROJECT_PATH}}/storage/app/public;
        expires 1y;
        add_header Cache-Control "public";
    }
    
    # Deny access to sensitive files
    location ~ /\. {
        deny all;
    }
    
    location ~ /\.env {
        deny all;
    }
    
    location ~ /storage/app {
        deny all;
    }
}

# Custom Domain Server Block (for mapped domains)
# This will be dynamically managed by your tenant management system
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name custom-school.edu www.custom-school.edu;
#     
#     # Individual SSL cert per custom domain
#     ssl_certificate /etc/ssl/certs/custom-school.edu.crt;
#     ssl_certificate_key /etc/ssl/private/custom-school.edu.key;
#     
#     # Same configuration as tenant block
#     root {{PROJECT_PATH}}/public;
#     # ... rest of config similar to tenant block
# }

# Rate Limiting
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=api:10m rate=60r/m;

# Apply rate limits to sensitive endpoints
location ~ ^/(login|register|password) {
    limit_req zone=login burst=10 nodelay;
    try_files $uri $uri/ /index.php?$query_string;
}

location ~ ^/api/ {
    limit_req zone=api burst=120 nodelay;
    try_files $uri $uri/ /index.php?$query_string;
}

# Gzip Compression
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_proxied any;
gzip_comp_level 6;
gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/json
    application/javascript
    application/xml+rss
    application/atom+xml
    image/svg+xml;
