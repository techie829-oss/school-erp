version: "3.9"

services:
  app:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: school-erp-app:${BUILD_NUMBER:-latest}
    container_name: school_erp_app
    restart: unless-stopped
    working_dir: /var/www
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
    volumes:
      - school_storage:/var/www/storage
      - school_cache:/var/www/bootstrap/cache
      - ./.env:/var/www/.env:ro
    networks:
      - school_network
      - mysql_default
    healthcheck:
      test: ["CMD-SHELL", "php-fpm-healthcheck || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  nginx:
    image: nginx:alpine
    container_name: school_erp_nginx
    restart: unless-stopped
    ports:
      - "127.0.0.1:9001:80"
    volumes:
      - ./src/public:/var/www/public:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      app:
        condition: service_healthy
    networks:
      - school_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  queue:
    image: school-erp-app:${BUILD_NUMBER:-latest}
    container_name: school_erp_queue
    restart: unless-stopped
    working_dir: /var/www
    command: php artisan queue:work --sleep=3 --tries=3 --max-time=3600
    environment:
      - APP_ENV=production
    volumes:
      - school_storage:/var/www/storage
      - ./.env:/var/www/.env:ro
    networks:
      - school_network
      - mysql_default
    depends_on:
      app:
        condition: service_healthy

  scheduler:
    image: school-erp-app:${BUILD_NUMBER:-latest}
    container_name: school_erp_scheduler
    restart: unless-stopped
    working_dir: /var/www
    command: php artisan schedule:work
    environment:
      - APP_ENV=production
    volumes:
      - school_storage:/var/www/storage
      - ./.env:/var/www/.env:ro
    networks:
      - school_network
      - mysql_default
    depends_on:
      app:
        condition: service_healthy

networks:
  school_network:
    driver: bridge
  mysql_default:
    external: true

volumes:
  school_storage:
    driver: local
  school_cache:
    driver: local