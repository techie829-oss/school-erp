services:
  # 1. Main Application Service (PHP-FPM + Laravel)
  app:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: school-erp-app:latest
    container_name: school_erp_app
    restart: always
    volumes:
      # Mount Host Code
      - .:/var/www
      # Preserve Image Artifacts (Named Volumes)
      - app_vendor:/var/www/vendor
      - app_node_modules:/var/www/node_modules
      - public_build:/var/www/public/build
      # Persistent Storage & Env
      - school_storage:/var/www/storage
      - ${ENV_PATH}:/var/www/.env
    networks:
      - school_network
      - mysql_default

  # 2. Web Server Service (Nginx Reverse Proxy)
  nginx:
    # Use custom build to bundle config or just image + mount
    # Using image + mount for flexibility as per "mount full"
    image: nginx:stable-alpine
    container_name: school_erp_nginx
    restart: always
    ports:
      - "127.0.0.1:9001:80"
    volumes:
      # Share App's Public Build Directory
      - public_build:/var/www/public/build
      # Mount Host Code for Static Files
      - .:/var/www
      # Nginx Log
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - app
    networks:
      - school_network

networks:
  school_network:
    driver: bridge
  mysql_default:
    external: true

volumes:
  school_storage:
  public_build:
  app_vendor:
  app_node_modules:
